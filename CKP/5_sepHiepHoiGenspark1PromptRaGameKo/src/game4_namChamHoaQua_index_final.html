<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khám Phá Phép Chia: Nhóm Đồ Vật</title>
    <style>
        body {
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            background-color: #f0f8ff;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }
        
        h1 {
            color: #4b0082;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
            animation: bounce 1s ease infinite alternate;
        }
        
        @keyframes bounce {
            from { transform: translateY(0px); }
            to { transform: translateY(-5px); }
        }
        
        .instructions {
            background-color: #fff;
            border: 3px solid #9370db;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            max-width: 780px;
            text-align: center;
            font-size: 18px;
            color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .instructions:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .story-container {
            background-color: #fff8e1;
            border: 3px solid #ffa726;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            max-width: 780px;
            text-align: center;
            font-size: 18px;
            color: #5d4037;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .story-container img {
            max-width: 100px;
            margin: 10px;
        }
        
        .progress-bar {
            display: flex;
            justify-content: space-between;
            width: 780px;
            margin-bottom: 20px;
            background-color: #fff;
            border: 3px solid #9370db;
            border-radius: 15px;
            padding: 10px 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .progress-step:hover {
            transform: translateY(-5px);
        }
        
        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            border: 3px solid #9370db;
            transition: all 0.3s ease;
        }
        
        .step-circle.active {
            background-color: #9370db;
            color: white;
        }
        
        .step-circle.completed {
            background-color: #32cd32;
            color: white;
        }
        
        .step-label {
            font-size: 14px;
            color: #333;
            text-align: center;
        }
        
        .game-container {
            position: relative;
            width: 800px;
            height: 600px;
            background-color: white;
            border: 5px solid #9370db;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .game-container:hover {
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        .challenge-container {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 3px solid #ff69b4;
            border-radius: 10px;
            padding: 10px;
            font-size: 20px;
            color: #4b0082;
            z-index: 10;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .feedback-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: rgba(255, 255, 255, 0.95);
            border: 3px solid #32cd32;
            border-radius: 15px;
            padding: 20px;
            font-size: 28px;
            color: #32cd32;
            text-align: center;
            z-index: 20;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: pop-in 0.5s forwards;
        }
        
        @keyframes pop-in {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            70% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .progress-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 3px solid #4b0082;
            border-radius: 10px;
            padding: 10px;
            font-size: 18px;
            color: #4b0082;
            z-index: 10;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .button {
            background-color: #ff69b4;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: absolute;
        }
        
        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .reset-button {
            bottom: 20px;
            left: 20px;
            background-color: #ff69b4;
        }
        
        .next-button {
            bottom: 20px;
            left: 150px;
            background-color: #32cd32;
            display: none;
        }
        
        .hint-button {
            top: 20px;
            right: 20px;
            background-color: #4b0082;
        }
        
        .auto-group-button {
            bottom: 70px;
            left: 20px;
            background-color: #ffa726;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            border-radius: 50%;
            pointer-events: none;
            z-index: 30;
        }
        
        .hint-visual {
            position: absolute;
            top: 70px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            border: 3px solid #ff69b4;
            border-radius: 10px;
            padding: 10px;
            font-size: 18px;
            color: #4b0082;
            z-index: 10;
            display: none;
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
            animation: slide-in 0.5s forwards;
        }
        
        @keyframes slide-in {
            from { transform: translateX(-50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .temp-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.95);
            border: 3px solid #ff6347;
            border-radius: 15px;
            padding: 20px;
            font-size: 24px;
            color: #ff6347;
            text-align: center;
            z-index: 20;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            animation: fade-in-out 1.5s forwards;
        }
        
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        
        .completion-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.95);
            border: 3px solid #32cd32;
            border-radius: 15px;
            padding: 30px;
            font-size: 32px;
            color: #32cd32;
            text-align: center;
            z-index: 30;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            animation: scale-in 0.7s forwards;
        }
        
        @keyframes scale-in {
            0% { transform: translate(-50%, -50%) scale(0.1); opacity: 0; }
            60% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .restart-button {
            background-color: #32cd32;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 20px;
            margin-top: 20px;
            cursor: pointer;
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .restart-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .object-area {
            position: absolute;
            top: 80px;
            left: 20px;
            width: 760px;
            height: 200px;
            background-color: #f8f8f8;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTBlMGUwIiBzdHJva2Utd2lkdGg9IjIiIGQ9Ik0wLDAgTDEwMCwxMDAiLz48cGF0aCBmaWxsPSJub25lIiBzdHJva2U9IiNlMGUwZTAiIHN0cm9rZS13aWR0aD0iMiIgZD0iTTEwMCwwIEwwLDEwMCIvPjwvc3ZnPg==');
            border: 2px dashed #9370db;
            border-radius: 10px;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            padding: 10px;
            overflow-y: auto;
        }
        
        .group-container {
            display: flex;
            justify-content: space-around;
            position: absolute;
            top: 320px;
            left: 20px;
            width: 760px;
            height: 220px;
        }
        
        .group {
            width: 140px;
            height: 200px;
            background-color: #f0f0f0;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDUwIDUwIj48Y2lyY2xlIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZTBlMCIgc3Ryb2tlLXdpZHRoPSIyIiBjeD0iMjUiIGN5PSIyNSIgcj0iMjAiLz48L3N2Zz4=');
            border: 2px dashed #ff69b4;
            border-radius: 10px;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            padding: 10px;
            transition: all 0.3s ease;
            overflow-y: auto;
            position: relative;
        }
        
        .group.highlight {
            background-color: #ffe0f0;
            border: 2px solid #ff69b4;
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.7);
            transform: scale(1.05);
        }
        
        .group-label {
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 16px;
            color: #4b0082;
            font-weight: bold;
        }
        
        .group-counter {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ff69b4;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .object {
            width: 50px;
            height: 50px;
            margin: 5px;
            cursor: grab;
            user-select: none;
            position: relative;
            transition: transform 0.2s ease, filter 0.2s ease;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2));
        }
        
        .object:hover {
            transform: scale(1.1);
            filter: drop-shadow(3px 3px 3px rgba(0,0,0,0.3));
            z-index: 5;
        }
        
        .object:active {
            cursor: grabbing;
            transform: scale(1.2);
        }
        
        .object img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
            transition: all 0.2s ease;
        }
        
        .object.taped {
            outline: 3px solid #4CAF50;
            background-color: rgba(76, 175, 80, 0.2);
            border-radius: 50%;
            z-index: 5;
            transform: scale(1.1);
        }
        
        .equation-container {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            border: 3px solid #4b0082;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 24px;
            color: #4b0082;
            z-index: 10;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .equation-part {
            margin: 0 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .equation-part.highlight {
            color: #ff69b4;
            transform: scale(1.2);
        }
        
        .tape-cursor {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjNENBRjUwIiBkPSJNNDgwLDEyOEwzMiwxMjhMMzIsMzg0TDQ4MCwzODRaIi8+PHBhdGggZmlsbD0iIzM4OEUzQyIgZD0iTTQ4MCwxMjhMMjU2LDEyOEwyNTYsMzg0TDQ4MCwzODRaIi8+PHBhdGggZmlsbD0iI0ZGRkZGRiIgZD0iTTQ4LDE0NEw0NjQsMTQ0TDQ2NCwzNjhMNDgsMzY4WiIgb3BhY2l0eT0iMC4zIi8+PC9zdmc+');
            background-size: contain;
            pointer-events: none;
            z-index: 1000;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        .tape-active .tape-cursor {
            display: block;
        }
        
        .tape-active {
            cursor: none;
        }
        
        .tape-active .object:hover {
            transform: scale(1.1);
        }
        
        .taped-object {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
        }
        
        .character {
            position: absolute;
            bottom: 10px;
            right: 100px;
            width: 100px;
            height: 100px;
            z-index: 5;
            transition: all 0.3s ease;
        }
        
        .character img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .speech-bubble {
            position: absolute;
            bottom: 110px;
            right: 80px;
            background-color: white;
            border: 2px solid #9370db;
            border-radius: 15px;
            padding: 10px;
            width: 200px;
            font-size: 16px;
            color: #4b0082;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 30px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: #9370db transparent;
        }
        
        .character:hover + .speech-bubble {
            opacity: 1;
            transform: translateY(-10px);
        }
        
        .animation-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }
        
        .welcome-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .welcome-message {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .welcome-message h2 {
            color: #4b0082;
            margin-top: 0;
        }
        
        .welcome-message p {
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .start-button {
            background-color: #32cd32;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 20px;
            cursor: pointer;
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .start-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 850px) {
            .game-container {
                width: 95vw;
                height: 95vw;
                max-width: 800px;
                max-height: 600px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .instructions, .story-container {
                font-size: 16px;
                padding: 10px;
            }
            
            .progress-bar {
                width: 95vw;
                max-width: 780px;
            }
            
            .step-circle {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .step-label {
                font-size: 12px;
            }
            
            .object-area, .group-container {
                width: calc(95vw - 40px);
                max-width: 760px;
            }
            
            .group {
                width: calc((95vw - 100px) / 5);
                max-width: 140px;
            }
        }
    </style>
</head>
<body>
    <h1>Khám Phá Phép Chia: Nhóm Đồ Vật</h1>
    
    <div class="instructions">
        <p>Kéo các đồ vật vào các nhóm bằng nhau để học về phép chia!</p>
        <p>Hãy chia đều các đồ vật vào các nhóm sao cho mỗi nhóm có số lượng bằng nhau.</p>
        <p>Gợi ý: Di chuyển chuột gần đồ vật để dùng băng dính dán và kéo vào các nhóm.</p>
    </div>
    
    <div class="story-container">
        <p>Hôm nay, bạn và các bạn đang tổ chức một bữa tiệc trái cây. Mọi người cần chia đều số trái cây cho từng đĩa.</p>
        <p>Hãy giúp chia đều số trái cây vào các đĩa nhé!</p>
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRTY0QzNDIiBkPSJNMzk1LjcsMzA3LjljMCwxMDYuMS04Ni4xLDE5Mi4zLTE5Mi4zLDE5Mi4zUzExLjEsNDE0LDExLjEsMzA3LjljMC0xMDYuMSw4Ni4xLTE5Mi4zLDE5Mi4zLTE5Mi4zIFMzOTUuNywyMDEuOCwzOTUuNywzMDcuOXoiLz48cGF0aCBmaWxsPSIjMkVDQzcxIiBkPSJNMjM4LjQsNjYuN2MwLDAtNjQtNTkuNS0xMjMuNS0yNS4xYzAsMCw0LjEsNDEuNSw0MS41LDY0YzAsMCw1OS41LTQxLjUsODIsMFY2Ni43eiIvPjxwYXRoIGZpbGw9IiNCRjM5MkMiIGQ9Ik0zMDMuNCwzMDcuOWMwLDEwNi4xLTQ0LjYsMTkyLjMtMTAwLDE5Mi4zcy0xMDAtODYuMS0xMDAtMTkyLjNjMC0xMDYuMSw0NC42LTE5Mi4zLDEwMC0xOTIuMyBTMzAzLjQsMjAxLjgsMzAzLjQsMzA3Ljl6Ii8+PC9zdmc+" alt="Apple">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48Y2lyY2xlIGZpbGw9IiNGMzlDMTIiIGN4PSIyNTYiIGN5PSIyNTYiIHI9IjI1MCIvPjxwYXRoIGZpbGw9IiNFNjdFMjIiIGQ9Ik0yNTYsNmMtMTM4LjEsMC0yNTAsMTExLjktMjUwLDI1MGMwLDQ1LjUsMTIuMiw4OC4xLDMzLjUsMTI0LjdjNDQuMyw3Ni4yLDEyNy4yLDEyNS4zLDIxNi41LDEyNS4zIHMxNzIuMi00OS4xLDIxNi41LTEyNS4zYzIxLjMtMzYuNiwzMy41LTc5LjIsMzMuNS0xMjQuN0M1MDYsMTE3LjksMzk0LjEsNiwyNTYsNnoiLz48cGF0aCBmaWxsPSIjMkVDQzcxIiBkPSJNMjU2LDQxLjFjMCwwLTI1LjUtMjMuNi00OS4xLTEwYzAsMCwxLjYsMTYuNSwxNi41LDI1LjVjMCwwLDIzLjYtMTYuNSwzMi42LDBWNDEuMXoiLz48L3N2Zz4=" alt="Orange">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRjFDNDBGIiBkPSJNNDU2LjEsNjguNWMtMzEuOS0zMS45LTgzLjYtMzEuOS0xMTUuNSwwTDY4LjUsMzQwLjZjLTMxLjksMzEuOS0zMS45LDgzLjYsMCwxMTUuNXM4My42LDMxLjksMTE1LjUsMCBsMjcyLjEtMjcyLjFDNDg4LDE1Mi4xLDQ4OCwxMDAuNCw0NTYuMSw2OC41eiIvPjxwYXRoIGZpbGw9IiNGMzlDMTIiIGQ9Ik00NTYuMSw2OC41Yy0zMS45LTMxLjktODMuNi0zMS45LTExNS41LDBMMTg0LDE5NS4xbDEzNC40LDEzNC40bDEzNy43LTEzNy43IEM0ODgsMTUyLjEsNDg4LDEwMC40LDQ1Ni4xLDY4LjV6Ii8+PHBhdGggZmlsbD0iI0QzNTQwMCIgZD0iTTEzNy43LDM0MC42bC02OS4xLDY5LjFjLTMxLjksMzEuOS0zMS45LDgzLjYsMCwxMTUuNXM4My42LDMxLjksMTE1LjUsMGw2OS4xLTY5LjFMMTM3LjcsMzQwLjZ6Ii8+PC9zdmc+" alt="Banana">
    </div>
    
    <div class="progress-bar" id="progressBar">
        <!-- Progress steps will be added here dynamically -->
    </div>
    
    <div class="game-container">
        <div class="challenge-container">
            Thử thách: Chia <span id="totalObjects">12</span> đồ vật thành <span id="numGroups">3</span> nhóm bằng nhau
        </div>
        
        <div class="hint-visual" id="hintVisual">
            <p>Đây là cách chia <span id="hintText">12 ÷ 3 = 4</span>:</p>
            <div id="hintDiagram"></div>
        </div>
        
        <div class="feedback-container" id="feedback">
            <p>Tuyệt vời! 🎉</p>
            <p>Bạn đã chia <span id="feedbackTotal">12</span> đồ vật thành <span id="feedbackGroups">3</span> nhóm, mỗi nhóm có <span id="feedbackEach">4</span> đồ vật!</p>
        </div>
        
        <div class="progress-container">
            Đã hoàn thành: <span id="completedChallenges">0</span>/5
        </div>
        
        <div class="object-area" id="objectArea">
            <!-- Objects will be added here dynamically -->
        </div>
        
        <div class="group-container" id="groupContainer">
            <!-- Groups will be added here dynamically -->
        </div>
        
        <div class="equation-container">
            <div class="equation-part"><span id="equationTotal">12</span></div>
            <div class="equation-part">÷</div>
            <div class="equation-part"><span id="equationGroups">3</span></div>
            <div class="equation-part">=</div>
            <div class="equation-part"><span id="equationResult">?</span></div>
        </div>
        
        <button class="button reset-button" id="resetButton">Làm lại</button>
        <button class="button next-button" id="nextButton">Tiếp theo</button>
        <button class="button hint-button" id="hintButton">Gợi ý</button>
        <button class="button auto-group-button" id="autoGroupButton">Tự động chia</button>
        
        <div class="tape-cursor" id="tapeCursor"></div>
        
        <div class="character">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIj48Y2lyY2xlIGZpbGw9IiNGRkQzOEUiIGN4PSIxMDAiIGN5PSI2MCIgcj0iNTAiLz48Y2lyY2xlIGZpbGw9IiMzMzMiIGN4PSI4MCIgY3k9IjUwIiByPSI1Ii8+PGNpcmNsZSBmaWxsPSIjMzMzIiBjeD0iMTIwIiBjeT0iNTAiIHI9IjUiLz48cGF0aCBmaWxsPSJub25lIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMyIgZD0iTTcwLDgwIEMxMDAsMTAwIDEzMCw4MCAiLz48cGF0aCBmaWxsPSIjRkY2QjZCIiBkPSJNNTAsMTUwIEMxMDAsMjAwIDE1MCwxNTAgTDEyMCwxMDAgTDgwLDEwMCBaIi8+PC9zdmc+" alt="Character">
        </div>
        <div class="speech-bubble">
            Dùng băng dính để dán và kéo đồ vật vào các nhóm!
        </div>
        
        <div class="animation-container" id="animationContainer"></div>
        
        <div class="welcome-overlay" id="welcomeOverlay">
            <div class="welcome-message">
                <h2>Chào mừng đến với Khám Phá Phép Chia!</h2>
                <p>Hãy xem cách chia đều các đồ vật vào các nhóm nhé!</p>
                <p>Sau đó bạn có thể tự mình thử làm.</p>
                <button class="start-button" id="startDemoButton">Xem Ví Dụ</button>
            </div>
        </div>
    </div>

    <script>
        // Main game variables
        const objectArea = document.getElementById('objectArea');
        const groupContainer = document.getElementById('groupContainer');
        const totalObjectsSpan = document.getElementById('totalObjects');
        const numGroupsSpan = document.getElementById('numGroups');
        const feedbackElement = document.getElementById('feedback');
        const feedbackTotal = document.getElementById('feedbackTotal');
        const feedbackGroups = document.getElementById('feedbackGroups');
        const feedbackEach = document.getElementById('feedbackEach');
        const completedChallenges = document.getElementById('completedChallenges');
        const resetButton = document.getElementById('resetButton');
        const nextButton = document.getElementById('nextButton');
        const hintButton = document.getElementById('hintButton');
        const autoGroupButton = document.getElementById('autoGroupButton');
        const hintVisual = document.getElementById('hintVisual');
        const hintText = document.getElementById('hintText');
        const hintDiagram = document.getElementById('hintDiagram');
        const progressBar = document.getElementById('progressBar');
        const equationTotal = document.getElementById('equationTotal');
        const equationGroups = document.getElementById('equationGroups');
        const equationResult = document.getElementById('equationResult');
        const animationContainer = document.getElementById('animationContainer');
        const tapeCursor = document.getElementById('tapeCursor');
        const welcomeOverlay = document.getElementById('welcomeOverlay');
        const startDemoButton = document.getElementById('startDemoButton');
        
        // Game state
        const gameState = {
            currentChallenge: 0,
            challenges: [
                { total: 12, groups: 3, completed: false },
                { total: 10, groups: 2, completed: false },
                { total: 15, groups: 5, completed: false },
                { total: 20, groups: 4, completed: false },
                { total: 18, groups: 6, completed: false }
            ],
            completedCount: 0,
            tapedObject: null,
            objectElements: [],
            groupElements: [],
            autoProgressTimer: null,
            tapeActive: false,
            isDraggingObject: false
        };
        
        // Object types with their images
        const objectTypes = [
            { name: 'apple', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRTY0QzNDIiBkPSJNMzk1LjcsMzA3LjljMCwxMDYuMS04Ni4xLDE5Mi4zLTE5Mi4zLDE5Mi4zUzExLjEsNDE0LDExLjEsMzA3LjljMC0xMDYuMSw4Ni4xLTE5Mi4zLDE5Mi4zLTE5Mi4zIFMzOTUuNywyMDEuOCwzOTUuNywzMDcuOXoiLz48cGF0aCBmaWxsPSIjMkVDQzcxIiBkPSJNMjM4LjQsNjYuN2MwLDAtNjQtNTkuNS0xMjMuNS0yNS4xYzAsMCw0LjEsNDEuNSw0MS41LDY0YzAsMCw1OS41LTQxLjUsODIsMFY2Ni43eiIvPjxwYXRoIGZpbGw9IiNCRjM5MkMiIGQ9Ik0zMDMuNCwzMDcuOWMwLDEwNi4xLTQ0LjYsMTkyLjMtMTAwLDE5Mi4zcy0xMDAtODYuMS0xMDAtMTkyLjNjMC0xMDYuMSw0NC42LTE5Mi4zLDEwMC0xOTIuMyBTMzAzLjQsMjAxLjgsMzAzLjQsMzA3Ljl6Ii8+PC9zdmc+' },
            { name: 'orange', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48Y2lyY2xlIGZpbGw9IiNGMzlDMTIiIGN4PSIyNTYiIGN5PSIyNTYiIHI9IjI1MCIvPjxwYXRoIGZpbGw9IiNFNjdFMjIiIGQ9Ik0yNTYsNmMtMTM4LjEsMC0yNTAsMTExLjktMjUwLDI1MGMwLDQ1LjUsMTIuMiw4OC4xLDMzLjUsMTI0LjdjNDQuMyw3Ni4yLDEyNy4yLDEyNS4zLDIxNi41LDEyNS4zIHMxNzIuMi00OS4xLDIxNi41LTEyNS4zYzIxLjMtMzYuNiwzMy41LTc5LjIsMzMuNS0xMjQuN0M1MDYsMTE3LjksMzk0LjEsNiwyNTYsNnoiLz48cGF0aCBmaWxsPSIjMkVDQzcxIiBkPSJNMjU2LDQxLjFjMCwwLTI1LjUtMjMuNi00OS4xLTEwYzAsMCwxLjYsMTYuNSwxNi41LDI1LjVjMCwwLDIzLjYtMTYuNSwzMi42LDBWNDEuMXoiLz48L3N2Zz4=' },
            { name: 'banana', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRjFDNDBGIiBkPSJNNDU2LjEsNjguNWMtMzEuOS0zMS45LTgzLjYtMzEuOS0xMTUuNSwwTDY4LjUsMzQwLjZjLTMxLjksMzEuOS0zMS45LDgzLjYsMCwxMTUuNXM4My42LDMxLjksMTE1LjUsMCBsMjcyLjEtMjcyLjFDNDg4LDE1Mi4xLDQ4OCwxMDAuNCw0NTYuMSw2OC41eiIvPjxwYXRoIGZpbGw9IiNGMzlDMTIiIGQ9Ik00NTYuMSw2OC41Yy0zMS45LTMxLjktODMuNi0zMS45LTExNS41LDBMMTg0LDE5NS4xbDEzNC40LDEzNC40bDEzNy43LTEzNy43IEM0ODgsMTUyLjEsNDg4LDEwMC40LDQ1Ni4xLDY4LjV6Ii8+PHBhdGggZmlsbD0iI0QzNTQwMCIgZD0iTTEzNy43LDM0MC42bC02OS4xLDY5LjFjLTMxLjksMzEuOS0zMS45LDgzLjYsMCwxMTUuNXM4My42LDMxLjksMTE1LjUsMGw2OS4xLTY5LjFMMTM3LjcsMzQwLjZ6Ii8+PC9zdmc+' },
            { name: 'strawberry', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRTc0QzNDIiBkPSJNMzU2LjEsMTY3LjNjMCwxMTAuNC04OS41LDIwMC0yMDAsMjAwcy0yMDAtODkuNS0yMDAtMjAwYzAtNTUuMiwyMi40LTEwNS4yLDU4LjctMTQxLjMgQzUxLjEsOS45LDEwMS4xLTEyLjcsMTU2LjEsMTIuN2MwLDAsNTUuMi01NS4yLDEyMy44LDBDMzMzLjcsNjIsMzU2LjEsMTEyLDM1Ni4xLDE2Ny4zeiIvPjxwYXRoIGZpbGw9IiMyRUNDNzEiIGQ9Ik0xNTYuMSw1Ni4xYzAsMC0zMy43LTMxLjItNjQuOC0xMy4xYzAsMCwyLjEsMjEuOCwyMS44LDMzLjdjMCwwLDMxLjItMjEuOCw0My4xLDBWNTYuMXoiLz48cGF0aCBmaWxsPSIjQzAzOTJCIiBkPSJNMjU2LjEsMTY3LjNjMCwxMTAuNC00NC44LDIwMC0xMDAsMjAwcy0xMDAtODkuNS0xMDAtMjAwYzAtNTUuMiwyMi40LTEwNS4yLDU4LjctMTQxLjMgQzE1MS4xLDkuOSwxNTYuMSwyNS44LDE1Ni4xLDI1LjhWMTY3LjN6Ii8+PGNpcmNsZSBmaWxsPSIjRkZGRkZGIiBjeD0iMTAwIiBjeT0iMTAwIiByPSIxMCIvPjxjaXJjbGUgZmlsbD0iI0ZGRkZGRiIgY3g9IjE1MCIgY3k9IjE1MCIgcj0iMTAiLz48Y2lyY2xlIGZpbGw9IiNGRkZGRkYiIGN4PSIyMDAiIGN5PSIyMDAiIHI9IjEwIi8+PGNpcmNsZSBmaWxsPSIjRkZGRkZGIiBjeD0iMjUwIiBjeT0iMjUwIiByPSIxMCIvPjxjaXJjbGUgZmlsbD0iI0ZGRkZGRiIgY3g9IjEwMCIgY3k9IjIwMCIgcj0iMTAiLz48Y2lyY2xlIGZpbGw9IiNGRkZGRkYiIGN4PSIyMDAiIGN5PSIxMDAiIHI9IjEwIi8+PGNpcmNsZSBmaWxsPSIjRkZGRkZGIiBjeD0iMTUwIiBjeT0iMjUwIiByPSIxMCIvPjxjaXJjbGUgZmlsbD0iI0ZGRkZGRiIgY3g9IjI1MCIgY3k9IjE1MCIgcj0iMTAiLz48L3N2Zz4=' },
            { name: 'grape', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48Y2lyY2xlIGZpbGw9IiM5QjU5QjYiIGN4PSIxNTAiIGN5PSIzNTAiIHI9IjUwIi8+PGNpcmNsZSBmaWxsPSIjOUI1OUI2IiBjeD0iMjUwIiBjeT0iMzUwIiByPSI1MCIvPjxjaXJjbGUgZmlsbD0iIzlCNTlCNiIgY3g9IjM1MCIgY3k9IjM1MCIgcj0iNTAiLz48Y2lyY2xlIGZpbGw9IiM5QjU5QjYiIGN4PSIyMDAiIGN5PSIyNTAiIHI9IjUwIi8+PGNpcmNsZSBmaWxsPSIjOUI1OUI2IiBjeD0iMzAwIiBjeT0iMjUwIiByPSI1MCIvPjxjaXJjbGUgZmlsbD0iIzlCNTlCNiIgY3g9IjI1MCIgY3k9IjE1MCIgcj0iNTAiLz48cGF0aCBmaWxsPSIjMkVDQzcxIiBkPSJNMjUwLDUwYzAsMC0yNS0yMy4yLTQ4LjEtOS44YzAsMCwxLjYsMTYuMiwxNi4yLDI1YzAsMCwyMy4yLTE2LjIsMzIsMFY1MHoiLz48L3N2Zz4=' }
        ];
        
        // Initialize the game
        function init() {
            // Set up event listeners
            resetButton.addEventListener('click', resetObjects);
            nextButton.addEventListener('click', moveToNextChallenge);
            hintButton.addEventListener('click', toggleHint);
            autoGroupButton.addEventListener('click', autoGroupObjects);
            startDemoButton.addEventListener('click', startDemo);
            
            // Create progress bar
            createProgressBar();
            
            // Set first challenge
            setChallenge(0);
            
            // Add intro animation
            showIntroAnimation();
            
            // Set up tape functionality
            setupTape();
        }
        
        // Create progress bar
        function createProgressBar() {
            progressBar.innerHTML = '';
            
            gameState.challenges.forEach((challenge, index) => {
                const stepElement = document.createElement('div');
                stepElement.className = 'progress-step';
                stepElement.dataset.index = index;
                
                const circleElement = document.createElement('div');
                circleElement.className = 'step-circle';
                if (index === gameState.currentChallenge) {
                    circleElement.classList.add('active');
                }
                if (challenge.completed) {
                    circleElement.classList.add('completed');
                }
                circleElement.textContent = index + 1;
                
                const labelElement = document.createElement('div');
                labelElement.className = 'step-label';
                labelElement.textContent = `${challenge.total} ÷ ${challenge.groups}`;
                
                stepElement.appendChild(circleElement);
                stepElement.appendChild(labelElement);
                
                stepElement.addEventListener('click', () => {
                    setChallenge(index);
                    resetObjects();
                });
                
                progressBar.appendChild(stepElement);
            });
        }
        
        // Update progress bar
        function updateProgressBar() {
            const steps = progressBar.querySelectorAll('.progress-step');
            
            steps.forEach((step, index) => {
                const circle = step.querySelector('.step-circle');
                circle.classList.remove('active', 'completed');
                
                if (index === gameState.currentChallenge) {
                    circle.classList.add('active');
                }
                if (gameState.challenges[index].completed) {
                    circle.classList.add('completed');
                }
            });
        }
        
        // Show intro animation
        function showIntroAnimation() {
            const gameContainer = document.querySelector('.game-container');
            gameContainer.style.opacity = '0';
            gameContainer.style.transform = 'translateY(50px)';
            
            setTimeout(() => {
                gameContainer.style.transition = 'all 1s ease';
                gameContainer.style.opacity = '1';
                gameContainer.style.transform = 'translateY(0)';
            }, 300);
        }
        
        // Start demo
        function startDemo() {
            welcomeOverlay.style.display = 'none';
            
            // Show a message about what's happening
            showTemporaryMessage('Hãy xem cách chia đều các đồ vật!');
            
            // Start the auto-grouping with a slight delay
            setTimeout(() => {
                autoGroupObjects();
            }, 1000);
        }
        
        // Set the current challenge
        function setChallenge(index) {
            // Clear any existing auto-progress timer
            if (gameState.autoProgressTimer) {
                clearTimeout(gameState.autoProgressTimer);
                gameState.autoProgressTimer = null;
            }
            
            gameState.currentChallenge = index;
            const challenge = gameState.challenges[index];
            
            totalObjectsSpan.textContent = challenge.total;
            numGroupsSpan.textContent = challenge.groups;
            equationTotal.textContent = challenge.total;
            equationGroups.textContent = challenge.groups;
            equationResult.textContent = '?';
            
            hintText.textContent = `${challenge.total} ÷ ${challenge.groups} = ${challenge.total / challenge.groups}`;
            
            nextButton.style.display = 'none';
            updateProgressBar();
            
            // Create objects and groups
            createObjects(challenge.total);
            createGroups(challenge.groups);
            
            // Animate challenge container
            const challengeContainer = document.querySelector('.challenge-container');
            challengeContainer.style.animation = 'none';
            void challengeContainer.offsetWidth; // Trigger reflow
            challengeContainer.style.animation = 'pulse 2s infinite';
            
            // Highlight equation parts
            highlightEquationParts();
        }
        
        // Highlight equation parts
        function highlightEquationParts() {
            const equationParts = document.querySelectorAll('.equation-part');
            
            // Remove all highlights
            equationParts.forEach(part => {
                part.classList.remove('highlight');
            });
            
            // Highlight total and groups
            equationParts[0].classList.add('highlight');
            setTimeout(() => {
                equationParts[0].classList.remove('highlight');
                equationParts[2].classList.add('highlight');
                
                setTimeout(() => {
                    equationParts[2].classList.remove('highlight');
                    equationParts[4].classList.add('highlight');
                    
                    setTimeout(() => {
                        equationParts[4].classList.remove('highlight');
                    }, 1000);
                }, 1000);
            }, 1000);
        }
        
        // Create objects for the challenge
        function createObjects(total) {
            // Clear existing objects
            objectArea.innerHTML = '';
            gameState.objectElements = [];
            
            // Create new objects
            for (let i = 0; i < total; i++) {
                const objectType = objectTypes[i % objectTypes.length];
                const objectElement = document.createElement('div');
                objectElement.className = 'object';
                objectElement.dataset.index = i;
                
                const img = document.createElement('img');
                img.src = objectType.image;
                img.alt = objectType.name;
                
                objectElement.appendChild(img);
                objectArea.appendChild(objectElement);
                
                gameState.objectElements.push(objectElement);
            }
            
            // Animate objects appearing
            gameState.objectElements.forEach((obj, index) => {
                obj.style.opacity = '0';
                obj.style.transform = 'scale(0.5) translateY(20px)';
                
                setTimeout(() => {
                    obj.style.transition = 'all 0.3s ease';
                    obj.style.opacity = '1';
                    obj.style.transform = 'scale(1) translateY(0)';
                }, index * 50);
            });
        }
        
        // Create groups for the challenge
        function createGroups(numGroups) {
            // Clear existing groups
            groupContainer.innerHTML = '';
            gameState.groupElements = [];
            
            // Create new groups
            for (let i = 0; i < numGroups; i++) {
                const groupElement = document.createElement('div');
                groupElement.className = 'group';
                groupElement.dataset.index = i;
                
                // Add group label
                const labelElement = document.createElement('div');
                labelElement.className = 'group-label';
                labelElement.textContent = `Nhóm ${i + 1}`;
                groupElement.appendChild(labelElement);
                
                // Add group counter
                const counterElement = document.createElement('div');
                counterElement.className = 'group-counter';
                counterElement.textContent = '0';
                groupElement.appendChild(counterElement);
                
                groupContainer.appendChild(groupElement);
                
                gameState.groupElements.push(groupElement);
            }
            
            // Animate groups appearing
            gameState.groupElements.forEach((group, index) => {
                group.style.opacity = '0';
                group.style.transform = 'scale(0.8) translateY(20px)';
                
                setTimeout(() => {
                    group.style.transition = 'all 0.5s ease';
                    group.style.opacity = '1';
                    group.style.transform = 'scale(1) translateY(0)';
                }, index * 100 + 500); // Delay after objects appear
            });
        }
        
        // Set up tape functionality
        function setupTape() {
            // Add event listeners for mouse movement
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mouseup', handleMouseUp);
            
            // Touch events for mobile
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: false });
            
            // Activate tape mode
            activateTapeMode();
        }
        
        // Activate tape mode
        function activateTapeMode() {
            gameState.tapeActive = true;
            document.body.classList.add('tape-active');
        }
        
        // Handle mouse movement
        function handleMouseMove(e) {
            if (gameState.tapeActive) {
                const rect = document.querySelector('.game-container').getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // Update tape cursor position
                tapeCursor.style.left = mouseX + 'px';
                tapeCursor.style.top = mouseY + 'px';
                
                // Show tape cursor only when over object area
                const objectAreaRect = objectArea.getBoundingClientRect();
                if (
                    e.clientX >= objectAreaRect.left && 
                    e.clientX <= objectAreaRect.right && 
                    e.clientY >= objectAreaRect.top && 
                    e.clientY <= objectAreaRect.bottom
                ) {
                    tapeCursor.style.display = 'block';
                } else {
                    tapeCursor.style.display = 'none';
                }
                
                if (gameState.isDraggingObject && gameState.tapedObject) {
                    // Move the taped object with the mouse
                    moveObject(mouseX, mouseY);
                    
                    // Highlight group under mouse
                    highlightGroupUnderMouse(e.clientX, e.clientY);
                }
            }
        }
        
        // Handle mouse down
        function handleMouseDown(e) {
            if (gameState.tapeActive && !gameState.tapedObject) {
                // Find if we're clicking on an object in the object area
                const objectElement = findObjectAtPosition(e.clientX, e.clientY);
                
                if (objectElement) {
                    // Tape the object
                    tapeObject(objectElement);
                    
                    // Start dragging
                    gameState.isDraggingObject = true;
                    
                    const rect = document.querySelector('.game-container').getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    
                    // Create pickup animation
                    createPickupAnimation(mouseX, mouseY);
                    
                    e.preventDefault();
                }
            }
        }
        
        // Handle mouse up
        function handleMouseUp(e) {
            if (gameState.tapeActive && gameState.isDraggingObject && gameState.tapedObject) {
                // Stop dragging
                gameState.isDraggingObject = false;
                
                // Find if we're over a group
                const groupElement = findGroupAtPosition(e.clientX, e.clientY);
                
                if (groupElement) {
                    // Move taped object to group
                    placeObjectInGroup(groupElement);
                    
                    // Add drop animation
                    createDropAnimation(e.clientX, e.clientY);
                    
                    // Update group counter
                    updateGroupCounter(groupElement);
                    
                    // Check if challenge is completed
                    checkChallenge();
                } else {
                    // If not dropped on a group, return to object area
                    returnObjectToArea();
                }
                
                // Remove all highlights
                gameState.groupElements.forEach(group => {
                    group.classList.remove('highlight');
                });
            }
        }
        
        // Handle touch events
        function handleTouchMove(e) {
            if (gameState.tapeActive) {
                e.preventDefault();
                
                const touch = e.touches[0];
                const rect = document.querySelector('.game-container').getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;
                
                // Update tape cursor position
                tapeCursor.style.left = touchX + 'px';
                tapeCursor.style.top = touchY + 'px';
                
                // Show tape cursor only when over object area
                const objectAreaRect = objectArea.getBoundingClientRect();
                if (
                    touch.clientX >= objectAreaRect.left && 
                    touch.clientX <= objectAreaRect.right && 
                    touch.clientY >= objectAreaRect.top && 
                    touch.clientY <= objectAreaRect.bottom
                ) {
                    tapeCursor.style.display = 'block';
                } else {
                    tapeCursor.style.display = 'none';
                }
                
                if (gameState.isDraggingObject && gameState.tapedObject) {
                    // Move the taped object with the touch
                    moveObject(touchX, touchY);
                    
                    // Highlight group under touch
                    highlightGroupUnderMouse(touch.clientX, touch.clientY);
                }
            }
        }
        
        function handleTouchStart(e) {
            if (gameState.tapeActive && !gameState.tapedObject) {
                const touch = e.touches[0];
                
                // Find if we're touching an object in the object area
                const objectElement = findObjectAtPosition(touch.clientX, touch.clientY);
                
                if (objectElement) {
                    e.preventDefault();
                    
                    // Tape the object
                    tapeObject(objectElement);
                    
                    // Start dragging
                    gameState.isDraggingObject = true;
                    
                    const rect = document.querySelector('.game-container').getBoundingClientRect();
                    const touchX = touch.clientX - rect.left;
                    const touchY = touch.clientY - rect.top;
                    
                    // Create pickup animation
                    createPickupAnimation(touchX, touchY);
                }
            }
        }
        
        function handleTouchEnd(e) {
            if (gameState.tapeActive && gameState.isDraggingObject && gameState.tapedObject) {
                e.preventDefault();
                
                // Stop dragging
                gameState.isDraggingObject = false;
                
                let clientX, clientY;
                
                // Use the last known position
                if (e.changedTouches.length > 0) {
                    const touch = e.changedTouches[0];
                    clientX = touch.clientX;
                    clientY = touch.clientY;
                } else {
                    // Fallback to tape cursor position
                    const rect = tapeCursor.getBoundingClientRect();
                    clientX = rect.left + rect.width / 2;
                    clientY = rect.top + rect.height / 2;
                }
                
                // Find if we're over a group
                const groupElement = findGroupAtPosition(clientX, clientY);
                
                if (groupElement) {
                    // Move taped object to group
                    placeObjectInGroup(groupElement);
                    
                    // Add drop animation
                    createDropAnimation(clientX, clientY);
                    
                    // Update group counter
                    updateGroupCounter(groupElement);
                    
                    // Check if challenge is completed
                    checkChallenge();
                } else {
                    // If not dropped on a group, return to object area
                    returnObjectToArea();
                }
                
                // Remove all highlights
                gameState.groupElements.forEach(group => {
                    group.classList.remove('highlight');
                });
            }
        }
        
        // Find object at position
        function findObjectAtPosition(x, y) {
            const objects = objectArea.querySelectorAll('.object');
            
            for (let i = 0; i < objects.length; i++) {
                const obj = objects[i];
                const rect = obj.getBoundingClientRect();
                
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    return obj;
                }
            }
            
            return null;
        }
        
        // Tape object
        function tapeObject(objectElement) {
            // Set as taped object
            gameState.tapedObject = objectElement;
            
            // Add taped class
            objectElement.classList.add('taped');
            
            // Hide original object
            objectElement.style.opacity = '0';
            
            // Create taped object clone
            const tapedObjectClone = document.createElement('div');
            tapedObjectClone.className = 'taped-object';
            tapedObjectClone.innerHTML = objectElement.innerHTML;
            tapedObjectClone.style.position = 'absolute';
            tapedObjectClone.style.width = '50px';
            tapedObjectClone.style.height = '50px';
            tapedObjectClone.style.zIndex = '1000';
            tapedObjectClone.style.pointerEvents = 'none';
            tapedObjectClone.style.filter = 'drop-shadow(3px 3px 3px rgba(0,0,0,0.3))';
            
            // Add to game container
            document.querySelector('.game-container').appendChild(tapedObjectClone);
            
            // Create tape effect animation
            createTapeEffectAnimation(objectElement);
        }
        
        // Create tape effect animation
        function createTapeEffectAnimation(objectElement) {
            const rect = objectElement.getBoundingClientRect();
            const containerRect = document.querySelector('.game-container').getBoundingClientRect();
            
            const x = rect.left - containerRect.left + rect.width / 2;
            const y = rect.top - containerRect.top + rect.height / 2;
            
            const animation = document.createElement('div');
            animation.style.position = 'absolute';
            animation.style.left = x + 'px';
            animation.style.top = y + 'px';
            animation.style.width = '60px';
            animation.style.height = '60px';
            animation.style.borderRadius = '50%';
            animation.style.border = '3px solid #4CAF50';
            animation.style.transform = 'translate(-50%, -50%) scale(0.5)';
            animation.style.transition = 'all 0.3s ease-out';
            animation.style.zIndex = '5';
            
            animationContainer.appendChild(animation);
            
            setTimeout(() => {
                animation.style.transform = 'translate(-50%, -50%) scale(1.2)';
                animation.style.opacity = '0';
            }, 10);
            
            setTimeout(() => {
                animation.remove();
            }, 300);
        }
        
        // Move object
        function moveObject(x, y) {
            const tapedObjectClone = document.querySelector('.taped-object');
            if (tapedObjectClone) {
                tapedObjectClone.style.left = (x - 25) + 'px'; // Center horizontally
                tapedObjectClone.style.top = (y - 25) + 'px'; // Center vertically
            }
        }
        
        // Place object in group
        function placeObjectInGroup(groupElement) {
            if (gameState.tapedObject) {
                // Move object to group
                groupElement.appendChild(gameState.tapedObject);
                
                // Show original object
                gameState.tapedObject.style.opacity = '1';
                
                // Remove taped class
                gameState.tapedObject.classList.remove('taped');
                
                // Remove taped object clone
                const tapedObjectClone = document.querySelector('.taped-object');
                if (tapedObjectClone) {
                    tapedObjectClone.remove();
                }
                
                // Clear taped object
                gameState.tapedObject = null;
            }
        }
        
        // Return object to area
        function returnObjectToArea() {
            if (gameState.tapedObject) {
                // Show original object
                gameState.tapedObject.style.opacity = '1';
                
                // Remove taped class
                gameState.tapedObject.classList.remove('taped');
                
                // Remove taped object clone
                const tapedObjectClone = document.querySelector('.taped-object');
                if (tapedObjectClone) {
                    tapedObjectClone.remove();
                }
                
                // Clear taped object
                gameState.tapedObject = null;
            }
        }
        
        // Update group counter
        function updateGroupCounter(groupElement) {
            const counter = groupElement.querySelector('.group-counter');
            if (counter) {
                // Count objects in group (excluding the label and counter)
                const objectCount = groupElement.querySelectorAll('.object').length;
                counter.textContent = objectCount;
                
                // Animate counter
                counter.style.animation = 'none';
                void counter.offsetWidth; // Trigger reflow
                counter.style.animation = 'pulse 0.5s';
            }
        }
        
        // Update all group counters
        function updateAllGroupCounters() {
            gameState.groupElements.forEach(group => {
                updateGroupCounter(group);
            });
        }
        
        // Highlight group under mouse
        function highlightGroupUnderMouse(x, y) {
            // Remove all highlights
            gameState.groupElements.forEach(group => {
                group.classList.remove('highlight');
            });
            
            // Find group under mouse
            const groupElement = findGroupAtPosition(x, y);
            
            if (groupElement) {
                groupElement.classList.add('highlight');
            }
        }
        
        // Find which group is at a given position
        function findGroupAtPosition(x, y) {
            for (let i = 0; i < gameState.groupElements.length; i++) {
                const group = gameState.groupElements[i];
                const rect = group.getBoundingClientRect();
                
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    return group;
                }
            }
            
            return null;
        }
        
        // Create pickup animation
        function createPickupAnimation(x, y) {
            const animation = document.createElement('div');
            animation.style.position = 'absolute';
            animation.style.left = x + 'px';
            animation.style.top = y + 'px';
            animation.style.width = '50px';
            animation.style.height = '50px';
            animation.style.borderRadius = '50%';
            animation.style.backgroundColor = 'rgba(76, 175, 80, 0.3)';
            animation.style.transform = 'translate(-50%, -50%) scale(0)';
            animation.style.transition = 'all 0.3s ease-out';
            animation.style.zIndex = '5';
            
            animationContainer.appendChild(animation);
            
            setTimeout(() => {
                animation.style.transform = 'translate(-50%, -50%) scale(2)';
                animation.style.opacity = '0';
            }, 10);
            
            setTimeout(() => {
                animation.remove();
            }, 300);
        }
        
        // Create drop animation
        function createDropAnimation(x, y) {
            const animation = document.createElement('div');
            animation.style.position = 'absolute';
            animation.style.left = x + 'px';
            animation.style.top = y + 'px';
            animation.style.width = '60px';
            animation.style.height = '60px';
            animation.style.borderRadius = '50%';
            animation.style.border = '3px solid #ff69b4';
            animation.style.transform = 'translate(-50%, -50%) scale(0.5)';
            animation.style.transition = 'all 0.4s ease-out';
            animation.style.zIndex = '5';
            
            animationContainer.appendChild(animation);
            
            setTimeout(() => {
                animation.style.transform = 'translate(-50%, -50%) scale(1.5)';
                animation.style.opacity = '0';
            }, 10);
            
            setTimeout(() => {
                animation.remove();
            }, 400);
        }
        
        // Auto group objects
        function autoGroupObjects() {
            // Only work if all objects are in the object area
            if (objectArea.children.length !== gameState.objectElements.length) {
                showTemporaryMessage('Hãy đưa tất cả đồ vật về khu vực ban đầu trước khi tự động chia nhóm!');
                return;
            }
            
            const challenge = gameState.challenges[gameState.currentChallenge];
            const objectsPerGroup = challenge.total / challenge.groups;
            
            // Animate the auto-grouping
            animateAutoGrouping(objectsPerGroup);
        }
        
        // Animate auto-grouping
        function animateAutoGrouping(objectsPerGroup) {
            // Disable buttons during animation
            resetButton.disabled = true;
            autoGroupButton.disabled = true;
            hintButton.disabled = true;
            
            // Move objects one by one with animation
            let objectIndex = 0;
            let groupIndex = 0;
            
            function moveNextObject() {
                if (objectIndex >= gameState.objectElements.length) {
                    // All objects moved
                    resetButton.disabled = false;
                    autoGroupButton.disabled = false;
                    hintButton.disabled = false;
                    
                    // Update all group counters
                    updateAllGroupCounters();
                    
                    // Check if challenge is completed
                    checkChallenge();
                    return;
                }
                
                const obj = gameState.objectElements[objectIndex];
                const group = gameState.groupElements[groupIndex];
                
                // Get positions for animation
                const objRect = obj.getBoundingClientRect();
                const groupRect = group.getBoundingClientRect();
                const containerRect = document.querySelector('.game-container').getBoundingClientRect();
                
                // Create animation element
                const animObj = obj.cloneNode(true);
                animObj.style.position = 'absolute';
                animObj.style.left = (objRect.left - containerRect.left) + 'px';
                animObj.style.top = (objRect.top - containerRect.top) + 'px';
                animObj.style.zIndex = '100';
                animObj.style.transition = 'all 0.5s ease';
                
                document.querySelector('.game-container').appendChild(animObj);
                
                // Hide original
                obj.style.opacity = '0';
                
                // Animate to group
                setTimeout(() => {
                    const targetX = groupRect.left - containerRect.left + 20 + (group.children.length % 2) * 30;
                    const targetY = groupRect.top - containerRect.top + 20 + Math.floor(group.children.length / 2) * 30;
                    
                    animObj.style.left = targetX + 'px';
                    animObj.style.top = targetY + 'px';
                    
                    // Highlight target group
                    group.classList.add('highlight');
                    
                    setTimeout(() => {
                        // Move actual object to group
                        group.appendChild(obj);
                        obj.style.opacity = '1';
                        
                        // Update group counter
                        updateGroupCounter(group);
                        
                        // Remove animation element
                        animObj.remove();
                        
                        // Remove highlight
                        group.classList.remove('highlight');
                        
                        // Update indices for next object
                        objectIndex++;
                        if (group.querySelectorAll('.object').length >= objectsPerGroup) {
                            groupIndex = (groupIndex + 1) % gameState.groupElements.length;
                        }
                        
                        // Move next object
                        setTimeout(moveNextObject, 100);
                    }, 500);
                }, 100);
            }
            
            // Start the animation
            moveNextObject();
        }
        
        // Check if the challenge is completed
        function checkChallenge() {
            const challenge = gameState.challenges[gameState.currentChallenge];
            const expectedPerGroup = challenge.total / challenge.groups;
            
            // Check if all groups have the same number of objects
            let allGroupsEqual = true;
            let allObjectsPlaced = true;
            
            // Check if all objects are in groups
            if (objectArea.children.length > 0) {
                allObjectsPlaced = false;
            }
            
            // Check if all groups have the expected number of objects
            for (let i = 0; i < gameState.groupElements.length; i++) {
                const group = gameState.groupElements[i];
                if (group.querySelectorAll('.object').length !== expectedPerGroup) {
                    allGroupsEqual = false;
                    break;
                }
            }
            
            if (allGroupsEqual && allObjectsPlaced) {
                // Challenge completed!
                if (!gameState.challenges[gameState.currentChallenge].completed) {
                    gameState.challenges[gameState.currentChallenge].completed = true;
                    gameState.completedCount++;
                    completedChallenges.textContent = gameState.completedCount;
                    updateProgressBar();
                    
                    // Show confetti
                    createConfetti();
                    
                    // Update equation
                    equationResult.textContent = expectedPerGroup;
                    
                    // Highlight result
                    const resultPart = document.querySelectorAll('.equation-part')[4];
                    resultPart.classList.add('highlight');
                    
                    // Show feedback
                    feedbackTotal.textContent = challenge.total;
                    feedbackGroups.textContent = challenge.groups;
                    feedbackEach.textContent = expectedPerGroup;
                    feedbackElement.style.display = 'block';
                    
                    // Auto move to next challenge after 2 seconds
                    if (gameState.autoProgressTimer) {
                        clearTimeout(gameState.autoProgressTimer);
                    }
                    
                    gameState.autoProgressTimer = setTimeout(() => {
                        // Find next uncompleted challenge
                        if (gameState.completedCount < gameState.challenges.length) {
                            moveToNextChallenge();
                        } else {
                            // All challenges completed!
                            showAllCompletedMessage();
                        }
                        gameState.autoProgressTimer = null;
                    }, 2000);
                }
            }
        }
        
        // Toggle hint
        function toggleHint() {
            if (hintVisual.style.display === 'none' || hintVisual.style.display === '') {
                hintVisual.style.display = 'block';
                
                // Create hint diagram
                createHintDiagram();
                
                // Animate hint button
                hintButton.style.animation = 'pulse 0.5s';
                setTimeout(() => {
                    hintButton.style.animation = '';
                }, 500);
                
                // Auto-hide hint after 5 seconds
                setTimeout(() => {
                    hintVisual.style.display = 'none';
                }, 5000);
            } else {
                hintVisual.style.display = 'none';
            }
        }
        
        // Create hint diagram
        function createHintDiagram() {
            const challenge = gameState.challenges[gameState.currentChallenge];
            const objectsPerGroup = challenge.total / challenge.groups;
            
            hintDiagram.innerHTML = '';
            
            // Create a visual representation of the division
            for (let i = 0; i < challenge.groups; i++) {
                const groupDiv = document.createElement('div');
                groupDiv.style.display = 'flex';
                groupDiv.style.flexWrap = 'wrap';
                groupDiv.style.margin = '5px';
                groupDiv.style.padding = '5px';
                groupDiv.style.border = '1px dashed #9370db';
                groupDiv.style.borderRadius = '5px';
                groupDiv.style.position = 'relative';
                
                // Add counter
                const counterDiv = document.createElement('div');
                counterDiv.style.position = 'absolute';
                counterDiv.style.top = '2px';
                counterDiv.style.right = '2px';
                counterDiv.style.backgroundColor = '#ff69b4';
                counterDiv.style.color = 'white';
                counterDiv.style.borderRadius = '50%';
                counterDiv.style.width = '20px';
                counterDiv.style.height = '20px';
                counterDiv.style.display = 'flex';
                counterDiv.style.justifyContent = 'center';
                counterDiv.style.alignItems = 'center';
                counterDiv.style.fontSize = '12px';
                counterDiv.style.fontWeight = 'bold';
                counterDiv.textContent = objectsPerGroup;
                
                groupDiv.appendChild(counterDiv);
                
                for (let j = 0; j < objectsPerGroup; j++) {
                    const objectType = objectTypes[(i * objectsPerGroup + j) % objectTypes.length];
                    const img = document.createElement('img');
                    img.src = objectType.image;
                    img.alt = objectType.name;
                    img.style.width = '20px';
                    img.style.height = '20px';
                    img.style.margin = '2px';
                    
                    groupDiv.appendChild(img);
                }
                
                hintDiagram.appendChild(groupDiv);
            }
        }
        
        // Create confetti effect
        function createConfetti() {
            const confettiCount = 100;
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 800 + 'px';
                confetti.style.top = -10 + 'px';
                confetti.style.width = Math.random() * 10 + 5 + 'px';
                confetti.style.height = Math.random() * 10 + 5 + 'px';
                confetti.style.opacity = Math.random() + 0.5;
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                document.querySelector('.game-container').appendChild(confetti);
                
                // Animate confetti
                const animationDuration = Math.random() * 3 + 2;
                const xPos = Math.random() * 800;
                
                confetti.style.transition = `all ${animationDuration}s ease-out`;
                
                setTimeout(() => {
                    confetti.style.transform = `translate(${(Math.random() - 0.5) * 200}px, ${600 + 20}px) rotate(${Math.random() * 360}deg)`;
                    confetti.style.opacity = '0';
                }, 10);
                
                setTimeout(() => {
                    confetti.remove();
                }, animationDuration * 1000);
            }
        }
        
        // Move to next challenge
        function moveToNextChallenge() {
            // Hide feedback
            feedbackElement.style.display = 'none';
            nextButton.style.display = 'none';
            
            // Find next uncompleted challenge
            if (gameState.completedCount < gameState.challenges.length) {
                let nextChallenge = (gameState.currentChallenge + 1) % gameState.challenges.length;
                while (gameState.challenges[nextChallenge].completed && gameState.completedCount < gameState.challenges.length) {
                    nextChallenge = (nextChallenge + 1) % gameState.challenges.length;
                }
                
                setChallenge(nextChallenge);
                resetObjects();
            } else {
                // All challenges completed!
                showAllCompletedMessage();
            }
        }
        
        // Show message when all challenges are completed
        function showAllCompletedMessage() {
            const allCompletedMessage = document.createElement('div');
            allCompletedMessage.className = 'completion-message';
            allCompletedMessage.innerHTML = `
                <h2>Chúc mừng! 🎉</h2>
                <p>Bạn đã hoàn thành tất cả các thử thách chia phép!</p>
                <p>Bạn đã trở thành bậc thầy về phép chia!</p>
            `;
            
            document.querySelector('.game-container').appendChild(allCompletedMessage);
            
            // Create lots of confetti
            createConfetti();
            setTimeout(createConfetti, 500);
            setTimeout(createConfetti, 1000);
            
            // Add button to restart
            const restartButton = document.createElement('button');
            restartButton.className = 'restart-button';
            restartButton.textContent = 'Chơi lại';
            
            restartButton.addEventListener('click', () => {
                allCompletedMessage.remove();
                resetGame();
            });
            
            allCompletedMessage.appendChild(restartButton);
        }
        
        // Reset objects
        function resetObjects() {
            // Move all objects back to object area
            gameState.objectElements.forEach(object => {
                objectArea.appendChild(object);
                object.style.opacity = '1';
                object.classList.remove('taped');
            });
            
            // Reset equation
            equationResult.textContent = '?';
            
            // Clear any auto-progress timer
            if (gameState.autoProgressTimer) {
                clearTimeout(gameState.autoProgressTimer);
                gameState.autoProgressTimer = null;
            }
            
            // Hide feedback
            feedbackElement.style.display = 'none';
            
            // Hide hint
            hintVisual.style.display = 'none';
            
            // Clear taped object
            gameState.tapedObject = null;
            
            // Remove any taped object clone
            const tapedObjectClone = document.querySelector('.taped-object');
            if (tapedObjectClone) {
                tapedObjectClone.remove();
            }
            
            // Reset dragging state
            gameState.isDraggingObject = false;
            
            // Update all group counters
            updateAllGroupCounters();
            
            // Animate reset button
            resetButton.style.animation = 'pulse 0.5s';
            setTimeout(() => {
                resetButton.style.animation = '';
            }, 500);
        }
        
        // Reset the entire game
        function resetGame() {
            // Reset challenges
            gameState.challenges.forEach(challenge => {
                challenge.completed = false;
            });
            
            gameState.completedCount = 0;
            completedChallenges.textContent = '0';
            
            // Clear any auto-progress timer
            if (gameState.autoProgressTimer) {
                clearTimeout(gameState.autoProgressTimer);
                gameState.autoProgressTimer = null;
            }
            
            // Update progress bar
            updateProgressBar();
            
            // Set first challenge
            setChallenge(0);
            
            // Hide hint
            hintVisual.style.display = 'none';
            
            // Clear taped object
            gameState.tapedObject = null;
            
            // Remove any taped object clone
            const tapedObjectClone = document.querySelector('.taped-object');
            if (tapedObjectClone) {
                tapedObjectClone.remove();
            }
            
            // Reset dragging state
            gameState.isDraggingObject = false;
            
            // Show welcome overlay again
            welcomeOverlay.style.display = 'flex';
        }
        
        // Show temporary message
        function showTemporaryMessage(message) {
            const tempMessage = document.createElement('div');
            tempMessage.className = 'temp-message';
            tempMessage.textContent = message;
            
            document.querySelector('.game-container').appendChild(tempMessage);
            
            setTimeout(() => {
                tempMessage.remove();
            }, 1500);
        }
        
        // Initialize the game
        init();
    </script>
</body>
</html>
